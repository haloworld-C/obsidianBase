> 参考: [paper](Kinematics_dynamics_and_control_design_of_4WIS4WID.pdf)
### 构型说明
四个带机械限位的独立舵轮, 主要有平移， 自转， 边走边转等模式。
![4WIS configration](../../Resourse/4WIS.png)
#### 主要参数
- 车体坐标下左前轮距离X轴距离: b
- 车体坐标系下左前轮距离Y轴距离: a
- 左前轮车体坐标($x_1$, $y_1$) = (b, a)
- 右前轮车体坐标($x_2$, $y_2$) = (-b, a)
- 左后轮车体坐标($x_3$, $y_3$) = (b, -a)
- 右后轮车体坐标($x_4$, $y_4$) = (-b, -a)
- 车体坐标系下左前轮距离原点距离: k = $\sqrt{b^2 + a^2}$
- 轮子(左前， 右前， 左后， 右后)车体坐标系下的航向角: $\delta_1$, $\delta_2$, $\delta_3$, $\delta_4$
- 车体在世界坐标系下的旋量: $(V_x, V_y, \omega)$
### 运动学模型
> 思路: 车体的速度与自身旋转的速度叠加

$$
\begin{equation}
\begin{aligned}
    v_{xi} = v_i \ cos(\delta_i) = V_{x} - y_i \ \omega \\
    v_{yi} = v_i \ sin(\delta_i) = V_{y} + x_i \ \omega \\
\end{aligned}
\end{equation}
\tag{1.1}
$$
将上面的式子整理为矩阵形式(共4个轮子)
$$
\begin{equation}
P_{8x3}\left[ \begin{array}{c}
V_x \\
V_y  \\
\omega 
  \end{array} \right]=
X_{8x4}\left[ \begin{array}{c}
v_1\\
v_2\\
v_3\\
v_4\\
  \end{array} \right] 
\end{equation}
\tag{1.2}
$$
其中
$$
P_{8x3}=\left[ \begin{array}{ccc}
1 & 0 & -b\\
0 & 1 & a\\
1 & 0 & -b\\
0 & 1 & -a\\
1 & 0 & b\\
0 & 1 & -a\\
1 & 0 & b\\
0 & 1 & a\\
  \end{array} \right]
$$
$$
X_{8x4}=\left[ \begin{array}{cccc}
c(\delta_1) & 0 & 0 & 0\\
s(\delta_1) & 0 & 0 & 0\\
0 & c(\delta_2) & 0 & 0\\
0 & s(\delta_2) & 0 & 0\\
0 & 0 & c(\delta_3) & 0\\
0 & 0 & s(\delta_3) & 0\\
0 & 0 & 0 & c(\delta_4)\\
0 & 0 & 0 & s(\delta_4)\\
  \end{array} \right]
$$

其中$c(\cdot)$, $s(\cdot)$ 分别表示余弦和正弦函数。
又根据矩阵论相关知识， 对$P_{8x3}$进行求伪逆:
$$
P^+=\frac{1}{4}\left[ \begin{array}{ccc}
1 & 0  & 1 & 0 & 1  & 0 & 1 & 0 \\
0 & 1  & 0 & 1 & 0 & 1 & 0 & 1 \\
-b / K & a / K & -b / K & -a / K & b / K & -a / K & b / K & a / K \\
  \end{array} \right]
$$
其中$K = (a^2 + b^2) = k^2$
对公式(1.2)左右左乘$P^+$, 得到: 
$$
\begin{equation}
\begin{aligned}
    \left[ \begin{array}{ccc}
    V_x \\
    V_y \\
    \omega 
    \end{array} \right]= \frac{1}{4}
    \left[ \begin{array}{cccc}
    c(\delta_1) & c(\delta_2) & c(\delta_3) & c(\delta_4)\\
    s(\delta_1) & s(\delta_2) & s(\delta_3) & s(\delta_4)\\
    W_1 & W_2 & W_3 & W_4\\
    \end{array} \right]\left[ \begin{array}{c}
    v_1\\
    v_2\\
    v_3\\
    v_4\\
  \end{array} \right] 
\end{aligned}
\end{equation}
\tag{1.3}
$$

其中$W_i = (-y_ic(\delta_i) + x_is(\delta_i)) / K$

式1.3即为四舵轮底盘的正运动学公式， 对其求逆即为逆运动学公式(左乘X伪逆即可)
### 运动学公式的线性化
令$T=[V_x, V_y, \omega]^T, \delta=[\delta_1, \delta_2, \delta_3, \delta_4]^T, v=[v_1, v_2, v_3, v_4]^T$, 则式(1.3)可以写为如下形式:
$$
\begin{equation}
\begin{aligned}
    T &= f(\delta, v) \\ 
    &= \frac{1}{4}\left[ \begin{array}{cccc}
    c(\delta_1) & c(\delta_2) & c(\delta_3) & c(\delta_4)\\
    s(\delta_1) & s(\delta_2) & s(\delta_3) & s(\delta_4)\\
    W_1 & W_2 & W_3 & W_4\\
    \end{array} \right] v
\end{aligned}
\end{equation}
\tag{1.4}
$$
对式(1.4)在($\overline{\delta}, \overline{v}$)进行一阶泰勒展开， 可以得到:
$$
\begin{equation}
\begin{aligned}
    \overline{T} + \Delta T &= f(\overline{\delta}, \overline{v}) + \frac{\partial f}{\partial \delta} \Delta \delta + \frac{\partial f}{\partial v} \Delta v \\ 
    &= \frac{1}{4}\left[ \begin{array}{cccc}
    c(\overline{\delta_1}) & c(\overline{\delta_2}) & c(\overline{\delta_3}) & c(\overline{\delta_4})\\
    s(\overline{\delta_1}) & s(\overline{\delta_2}) & s(\overline{\delta_3}) & s(\overline{\delta_4})\\
    \overline{W_1} & \overline{W_2} & \overline{W_3} & \overline{W_4}\\
    \end{array} \right] \Delta v \\
  +& \frac{1}{4}\left[ \begin{array}{cccc}
    -\overline{v_1}s(\overline{\delta_1}) & -\overline{v_2}s(\overline{\delta_2}) & -\overline{v_3}s(\overline{\delta_3}) & -\overline{v_4}s(\overline{\delta_4}) \\
    \overline{v_1}c(\overline{\delta_1}) & \overline{v_2}c(\overline{\delta_2}) & \overline{v_3}c(\overline{\delta_3}) & \overline{v_4}c(\overline{\delta_4}) \\
     (b*s(\overline{\delta_1})+a*c(\overline{\delta_1}))\overline{v_1}/K & (b*s(\overline{\delta_2})-a*c(\overline{\delta_2}))\overline{v_2} /K & (-b*s(\overline{\delta_3})-a*c(\overline{\delta_3}))\overline{v_3}/K & (-b*s(\overline{\delta_4})+a*c(\overline{\delta_4}))\overline{v_4}/K\\
    \end{array} \right] \Delta \delta \\
    &= J_{v}\Delta v + J_{\delta}\Delta \delta
\end{aligned}
\end{equation}
\tag{1.5}
$$
### 翻转决策
### QP问题构造
>使用QP轮速/位置分配器的初衷是解决4个轮子控制响应的同步问题， 同时在该步骤考虑轮子的机械限位限制及平滑性， 以便上层在可以同时放开(V_x, V_y, w)的控制指令
QP中对于轮速需要翻转的情况无能为力， 需要再QP环节前进行决策， QP中单纯对舵轮角进行限制
由于式1.5为在当前状态线性化， 故需要对执行的$T_{target}$进行饱和限制,保证$\Delta T$较小， 否则也不符合运动学约束， 后续可以考虑提高QPallocator的频率， 以保证快速响应

> 如何保证精度呢， 关键在于应用nullspace control and HQP
#### 决策变量
设决策变量$$x=(\Delta{v_1}, \Delta{v_2}, \Delta{v_3}, \Delta{v_4}, \Delta{\delta_1},\Delta{\delta_2},\Delta{\delta_3},\Delta{\delta_4})$$ 故式1.4可写为:
$$
\begin{equation}
\begin{aligned}
    \Delta T &= f(x) \\ 
    &=  \left[ \begin{array}{cc}
    J_{v} & 0 \\
    0 & J_{\delta}
    \end{array} \right] x
\end{aligned}
\end{equation}
\tag{2.1}

$$
考虑带松弛变量的QP问题， 以保证四轮的协调性优先满足(用于等式约束):
$$
\begin{equation}
\begin{aligned}
    \Delta T &= f(x) \\ 
    &=  J x + s
\end{aligned}
\end{equation}
\tag{2.2}
$$
其中松弛变量$s=(s_x, s_y, s_w)$可以与$x$组成新的决策变量$z=(x,s)$
#### 代价函数
##### 标准QP形式
$$
\begin{equation}
\begin{aligned}
J(x) = \frac{1}{2}z^THz + g^Tz
\end{aligned}
\end{equation}
\tag{2.3}
$$
##### 运动学跟踪项
我们希望qp解算出来的$x$与当前的舵轮角度与轮速叠加对应的T与命令值$T_{cmd}$尽量接近。
令$\Delta{T}=T_{cmd}-T_{current}$
$$
\begin{equation}
\begin{aligned}
J_{track}=w_1∥Jx−ΔT∥^2 \\
\end{aligned}
\end{equation}
\tag{2.4}
$$

式2.2展开, 有：
$$
\begin{equation}
\begin{aligned}
J_{track}&=(Jx-\Delta{T})^Tw_1(Jx-\Delta{T}) \\
        &=x^T(J^Tw_1J)x-2x^T(J^Tw_1\Delta{T})+(\Delta{T})^Tw_1(\Delta{T})
\end{aligned}
\end{equation}
\tag{2.5}
$$
##### 指令平滑项
$$
\begin{equation}
\begin{aligned}
J_{smooth}=w_2∥x∥^2 \\
\end{aligned}
\end{equation}
\tag{2.6}
$$
##### 接近死区惩罚项
目前暂不考虑
##### 松弛项
$$
\begin{equation}
\begin{aligned}
J_{slack}=w_3∥s∥^2 \\
\end{aligned}
\end{equation}
\tag{2.7}
$$
##### 代价矩阵
Hessian矩阵:
$$
\begin{equation}
H = diag(J^Tw_1J+w_2, w_3)
\end{equation}
\tag{2.8}
$$
梯度矩阵:
$$
\begin{equation}
g = (-J^Tw_1\Delta{T}, 0)
\end{equation}
\tag{2.9}
$$

#### 约束矩阵
##### 等式约束
见式2.2
##### 不等式约束
$$
lb≤x≤ub
$$
- 转向角限位
$$
\delta_{i,min} - \delta_{prev,i} \leq \Delta\delta_i \leq \delta_{i,max} - \delta_{prev,i}
$$
- 轮速限位：
$$
-v_{max} - v_{prev,i} \leq \Delta v_i \leq v_{max} - v_{prev,i}
$$
- 转向速度限制
$$
-\dot{\delta}_{max} \Delta t \leq \Delta\delta_i \leq \dot{\delta}_{max} \Delta t
$$
- 加速度限制
$$
-a_{max} \Delta t \leq \Delta v_i \leq a_{max} \Delta t
$$
- 零位限制
主要考虑小vx, vy时轻微的扰动会导致舵轮角的剧烈变化， 从而导致舵轮翻转。



### 考虑舵轮模型的运动学MPC

### 4WIS动力学模型
#### 拉格朗日动力学模型

### 考虑舵轮模型的动力学MPC

